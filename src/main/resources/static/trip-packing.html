<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trip Packing List</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 5px 4px; padding: 6px 12px; cursor: pointer; }
        input[type=text], input[type=number] { margin: 4px; }
        li { margin-bottom: 6px; }
    </style>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get("tripId");

        async function loadTemplates() {
          const resp = await fetch("/tripplanner/packing-templates");
          const templates = await resp.json();
          const container = document.getElementById("templatesList");
          container.innerHTML = "";
          templates.forEach(t => {
            const div = document.createElement("div");
            div.innerHTML = `
              <label>
                <input type="checkbox" value="${t.id}"> ${t.name} (v${t.version})
              </label>
            `;
            container.appendChild(div);
          });
        }

        async function assignTemplates() {
          const checked = Array.from(document.querySelectorAll("#templatesList input:checked"))
            .map(cb => parseInt(cb.value));
          if (checked.length === 0) return alert("Select at least one template");

          await fetch(`/tripplanner/trips/${tripId}/packing-list/from-templates`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ templateIds: checked })
          });
          loadPackingList();
        }

        async function loadPackingList() {
          const resp = await fetch(`/tripplanner/trips/${tripId}/packing-list`);
          const data = await resp.json();
          renderPackingList(data.items);
        }

        function renderPackingList(items) {
          const container = document.getElementById("packingList");
          container.innerHTML = "";
          items.forEach(i => {
            const li = document.createElement("li");
            li.innerHTML = `
              <input type="text" value="${i.name}" id="name-${i.id}">
              <input type="number" value="${i.quantity}" id="qty-${i.id}" style="width:60px;">
              <label><input type="checkbox" id="chk-${i.id}" ${i.checked ? "checked" : ""}> Packed</label>
              <button onclick="updateItem(${i.id})">Save</button>
              <button onclick="deleteItem(${i.id})">Delete</button>
            `;
            container.appendChild(li);
          });
        }

        async function addItem() {
          const name = document.getElementById("newName").value;
          const qty = parseInt(document.getElementById("newQty").value, 10);
          if (!name) return alert("Enter name");

          await fetch(`/tripplanner/trips/${tripId}/packing-list`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: null, name, quantity: qty, checked: false })
          });
          document.getElementById("newName").value = "";
          document.getElementById("newQty").value = 1;
          loadPackingList();
        }

        async function updateItem(id) {
          const name = document.getElementById(`name-${id}`).value;
          const qty = parseInt(document.getElementById(`qty-${id}`).value, 10);
          const checked = document.getElementById(`chk-${id}`).checked;
          await fetch(`/tripplanner/trips/${tripId}/packing-list/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, name, quantity: qty, checked })
          });
          loadPackingList();
        }

        async function deleteItem(id) {
          await fetch(`/tripplanner/trips/${tripId}/packing-list/${id}`, { method: "DELETE" });
          loadPackingList();
        }

        window.onload = () => {
          loadTemplates();
          loadPackingList();
        };
    </script>
</head>
<body>
<h1>Trip Packing List</h1>
<button onclick="window.location.href='trips.html'">‚Üê Back to Trips</button>

<h2>Assign Templates</h2>
<div id="templatesList"></div>
<button onclick="assignTemplates()">Assign Selected Templates</button>

<h2>Add Item</h2>
<input id="newName" type="text" placeholder="Item name">
<input id="newQty" type="number" value="1" style="width:60px;">
<button onclick="addItem()">Add</button>

<h2>Current Packing List</h2>
<ul id="packingList"></ul>
</body>
</html>
