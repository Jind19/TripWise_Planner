<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Packing Template</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label { display: block; margin: 5px 0; }
        input { margin-left: 10px; }
        button { margin-top: 10px; padding: 8px 14px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 6px; }
        .item-row { margin-bottom: 8px; }
    </style>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get("id");

        function addItemRow(name = "", qty = 1) {
          const container = document.getElementById("itemsContainer");
          const div = document.createElement("div");
          div.className = "item-row";
          div.innerHTML = `
            <label>
              Item Name: <input class="itemName" value="${name}" required>
              Quantity per Person: <input class="qty" type="number" value="${qty}" required style="width:60px;">
              <button type="button" onclick="this.parentElement.parentElement.remove()">Remove</button>
            </label>
          `;
          container.appendChild(div);
        }

        async function loadTemplate() {
          const resp = await fetch("/tripplanner/packing-templates");
          const templates = await resp.json();
          const template = templates.find(t => t.id == templateId);

          if (!template) {
            document.body.innerHTML = "<h2>Template not found</h2>";
            return;
          }

          document.getElementById("name").value = template.name;
          document.getElementById("description").value = template.description || "";

          const container = document.getElementById("itemsContainer");
          container.innerHTML = "";
          template.items.forEach(i => addItemRow(i.name, i.defaultQuantity));
        }

        async function updateTemplate() {
          const name = document.getElementById("name").value;
          const description = document.getElementById("description").value;

          const itemNames = document.querySelectorAll(".itemName");
          const qtys = document.querySelectorAll(".qty");

          const items = [];
          for (let i = 0; i < itemNames.length; i++) {
            items.push({
              name: itemNames[i].value,
              qtyPerPerson: parseInt(qtys[i].value, 10),
              notes: ""
            });
          }

          const payload = { name, description, items, active: true };

          const resp = await fetch(`/tripplanner/packing-templates/${templateId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await resp.json();
          document.getElementById("result").textContent =
            JSON.stringify(data, null, 2);
        }

        window.onload = loadTemplate;
    </script>
</head>
<body>
<h1>Edit Packing Template</h1>
<form onsubmit="event.preventDefault(); updateTemplate();">
    <label>Template Name: <input id="name" required></label>
    <label>Description: <input id="description"></label>

    <h3>Items</h3>
    <div id="itemsContainer"></div>
    <button type="button" onclick="addItemRow()">+ Add Item</button><br><br>

    <button type="submit">Update Template</button>
</form>

<h2>Response</h2>
<pre id="result"></pre>

<button onclick="window.location.href='templates.html'">‚Üê Back to Templates List</button>
</body>
</html>
